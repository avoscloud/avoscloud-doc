{% import "views/_data.njk" as data %}
{% import "views/_parts.html" as include %}
{% import "views/_helper.njk" as docs %}
{% import "views/_im.njk" as im %}

## 即时通讯常见问题

### 即时通讯云端错误码说明

即时通讯的错误码会以 SDK 异常或 WebSocket 关闭状态码的形式返回给客户端。当出现异常情况时，SDK 会输出状态码到日志里，以下是对部分状态码的简单说明：

{{ im.errorCodes('table') }}

### 要让单个群组消息进入「免打扰模式」，该如何做

对于普通对话的新消息，LeanCloud 即时通讯服务有选项支持将消息以 Push Notification 的方式通知当前不在线的成员，但是有时候，这种推送会非常频繁对用户造成干扰。LeanCloud 提供选项，支持让单个用户关闭特定对话的离线消息推送。具体可以参考 [消息免打扰](realtime-guide-senior.html#消息免打扰) 文档。

### 聊天好友关系如何实现

LeanCloud 即时通讯服务是完全独立的即时通讯业务抽象，专注在即时通讯本身，所以即时通讯的业务逻辑中，并不含有好友关系，以及对应的聊天用户数据信息（如头像、名称等）。即时通讯与其他业务逻辑完全隔离，不耦合，唯一关联的就是 clientId。这样做的好处是显而易见的，比如你可以很容易让匿名用户直接通信，你也可以自定义一些好友逻辑，总之可以做成因为任意逻辑而匹配产生的聊天行为。

当然，如果你想维护一套好友关系，完全可以使用你自己的逻辑，只要存储着每个用户在即时通讯中的 clientId 即可。我们推荐使用 LeanCloud 的存储，即 LeanStorage，这样可以结合 LeanCloud 中的 User 相关对象来简单地实现账户系统，以及与之相关的存储，详情可以阅读对应的 SDK 开发指南。

### 聊天记录的保存时间和条数

{{ im.messagesLifespan("") }}

### 聊天消息没有收到，该如何排查

当出现聊天消息没有收到的情况，你可以按照以下思路排查：

* 调用消息记录 API 查看消息是否到达了云端
* 如果只有一个消息接收者，可以检查消息记录中对应条目的 `ack-at` 字段判断消息是否到达了客户端
* 在 [控制台 > **消息** > **即时通讯** > **用户**](/dashboard/messaging.html?appid={{appid}}#/message/realtime/client) 页面的文本框里输入对应的 Client ID，查看是否在线，以及是否有离线消息。
* 在 `控制台 > **消息** > **即时通讯** > **对话**` 页面的文本框里输入消息所属对话 ID，在 `消息与日志` 一栏里选日志，根据消息发送时间查看消息发送日志，看服务器是否有收到消息请求，消息是否有转发记录，转发消息时目标用户是否在线等信息。

### 为什么我收不到离线消息推送

首先请参考 [聊天消息没有收到](#聊天消息没有收到) 一节内容查看聊天消息是否有正常送达服务器。

其次请利用控制台即时消息页的用户状态查询页面来确认消息接收者是否真的处于离线状态，是否有未读消息产生，是否在 `_Installation` 表内有关联的设备，如下图所示。如果接收者处于在线状态能正常接收消息则不会有未读消息计数，也不会触发推送，请先让接收者离线后再测试离线消息推送。如果用户在 `_Installation` 表内没有关联的设备则也无法触发推送，对于 iOS 设备请确认接收者设备是否有正常从 APNs 申请到 Device Token，是否有正常存储设备记录在 `_Installation` 表中，对于 Android 设备请确认是否开启了混合推送，是否正常存储了设备记录在 `_Installation` 表中。

![image](images/realtime_faq_console.png)

接着请参考[离线推送通知](realtime-guide-intermediate.html#离线推送通知)一节内容确认您应用是否有配置默认的推送内容，或是否有通过云引擎 Hook 、消息附件方式为期望产生离线推送的消息动态设置了离线消息推送内容。没有设置离线消息推送内容也无法触发离线消息推送。

之后请在 [控制台 > **消息** > **推送消息** > **在线发送**](/dashboard/messaging.html?appid={{appid}}#/message/push/create) 页面尝试给接收者用户 Client ID 在 `_Installation` 表关联的设备单独发推送，查看推送是否能收到。可以通过推送记录查看是否有错误产生。如看到 `Invalid Token` 计数非 0 表示目标 iOS 设备的 Device Token 过期或 Device Token 和推送使用的证书不匹配或目标 Device Token 和推送使用的环境不匹配。请尝试切换推送证书，确认目标 Device Token 是 Production 环境还是 Development 环境后再重新推送，不匹配的证书或不匹配的推送环境均会导致推送失败。如何切换离线推送通知的证书请参考 [离线推送通知](realtime-guide-intermediate.html#离线推送通知)

检查方法总结如下：

* 检查消息是否正常发送到服务器
* 检查接收者用户是否离线，是否在 `_Installation` 表中有关联的设备记录
* 检查是否有设置推送内容
* 使用控制台推送在线发送工具实际发推送给目标设备查看推送是否出错，比如 iOS 证书不匹配，设备 Token 过期，设备 Token 和推送环境不匹配等

### Android 设备系统时间不准，会影响即时通讯服务吗？

可能会，取决于证书的时间。当错误的系统时间和当前时间的误差，大于证书的有效时间，就会导致 SSL 握手失败，进而让即时通讯服务整体不可用。

### 我只想实现两个用户的私聊，是不是每次都得重复创建对话？

不需要重复创建。我们推荐的方式是开发者可以用**自定义属性**来实现对私聊和群聊的标识，并且在进行私聊之前，需要查询当前两个参与对话的 ClientId 是否之前已经存在一个私聊的对话了。{% block goto_create_unique_conversation %}另外，SDK 已经提供了创建唯一对话的接口，请查看 [创建对话](#创建对话)。{% endblock %}


### 某个成员退出对话之后，再加入，在他离开的这段期间内的产生的聊天记录，他还能获取么？

可以。目前聊天记录从属关系是属于对话的，也就是说，只要对话 Id 不变，不论人员如何变动，只要这个对话产生的聊天记录，当前成员都可以获取。

### 我自己没有云端，如何实现签名的功能？

LeanCloud 云引擎提供了托管 Python 和 Node.js 运行的方式，开发者可以所以用这两种语言按照签名的算法实现签名，完全可以支持开发者的自定义权限控制。
